# Архітектура проекту Budget Helper

## 🏗️ Загальна архітектура

```
┌─────────────────────────────────────────────────────────┐
│                   Telegram User                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│                   main.py (Entry Point)                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │  1. init_db()                                   │   │
│  │  2. init_bot()                                  │   │
│  │  3. bot.infinity_polling()                      │   │
│  └─────────────────────────────────────────────────┘   │
└───────────────────┬─────────────────────────────────────┘
                    │
        ┌───────────┴────────────┐
        ▼                        ▼
┌──────────────┐        ┌──────────────────┐
│  database/   │        │  bot/            │
│  init_db()   │        │  bot_instance.py │
└──────────────┘        └───────┬──────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
        ┌──────────┐    ┌──────────┐   ┌──────────┐
        │handlers/ │    │keyboards/│   │locales/  │
        └──────────┘    └──────────┘   └──────────┘
                │
        ┌───────┼───────┬─────────┬─────────┐
        ▼       ▼       ▼         ▼         ▼
    start.py income.py finance.py misc.py  ...
```

## 📦 Модулі та їх відповідальність

### 1. main.py
**Відповідальність:** Точка входу в додаток
- Ініціалізація БД
- Ініціалізація бота
- Запуск infinity polling

### 2. config.py
**Відповідальність:** Конфігурація
- Завантаження змінних з .env
- Валідація конфігурації

### 3. constants.py
**Відповідальність:** Константи проекту
- Типи доходів/витрат
- Періоди часу
- Назви валют
- Інші константи

### 4. bot/
**Відповідальність:** Конфігурація та ініціалізація бота
```python
bot/
├── __init__.py           # Експорт bot та init_bot
└── bot_instance.py       # Створення TeleBot + реєстрація handlers
```

**Потік роботи:**
1. Створення екземпляра TeleBot з TOKEN
2. Імпорт всіх handlers
3. Реєстрація всіх handlers через register_handlers(bot)

### 5. database/
**Відповідальність:** Робота з базою даних
```python
database/
├── __init__.py              # Експорт всіх функцій
├── db_manager.py            # Менеджер БД
│   ├── get_connection()     # З'єднання з БД
│   ├── init_db()            # Створення таблиць
│   └── ensure_user()        # Перевірка користувача
├── income_repository.py     # Репозиторій доходів
│   ├── add_income()         # Додати дохід
│   └── get_incomes_aggregated()  # Отримати доходи
├── expense_repository.py    # Репозиторій витрат
│   ├── add_expense()        # Додати витрату
│   └── get_expenses_aggregated() # Отримати витрати
└── utils.py                 # Допоміжні функції
    └── get_date_range_for_period()  # Діапазони дат
```

**Паттерн:** Repository Pattern
- Кожна таблиця має свій repository
- Repository інкапсулює всю логіку роботи з таблицею
- Легко тестувати та замінити БД

### 6. handlers/
**Відповідальність:** Обробка повідомлень від користувача
```python
handlers/
├── __init__.py          # Експорт всіх handlers
├── start.py             # /start, /help
├── income.py            # Додавання доходів
├── expenses.py          # Додавання витрат
├── finance.py           # Перегляд фінансів
├── report.py            # Звіти та аналітика
├── settings.py          # Налаштування
└── misc.py              # Інші функції
```

**Структура handler:**
```python
def register_handlers(bot):
    """Реєстрація обробників."""
    
    @bot.message_handler(...)
    def handler_function(message):
        """Обробка повідомлення."""
        # Логіка обробки
```

### 7. keyboards/
**Відповідальність:** Створення клавіатур
```python
keyboards/
├── __init__.py              # Експорт всіх клавіатур
└── main_keyboards.py        # Основні клавіатури
    ├── main_menu()          # Головне меню
    ├── finance_submenu()    # Підменю фінансів
    ├── back_button()        # Кнопка назад
    └── create_timeframe_keyboard()  # Вибір періоду
```

**Переваги централізації:**
- Уникнення дублювання коду
- Легко змінювати дизайн клавіатур
- Зручно підтримувати

### 8. locales/
**Відповідальність:** Локалізація (переклади)
```python
locales/
├── __init__.py              # Експорт функцій локалізації
├── locale_manager.py        # Менеджер локалізації
│   ├── get_text()           # Отримати текст
│   ├── set_language()       # Встановити мову
│   ├── get_income_types()   # Типи доходів
│   ├── get_expense_types()  # Типи витрат
│   └── get_time_frames()    # Періоди часу
├── uk.py                    # Українська мова
└── en.py                    # Англійська мова
```

**Як працює:**
1. Кожна мова - окремий файл з словником
2. locale_manager керує доступом до текстів
3. get_text(key) повертає текст для поточної мови

### 9. models/
**Відповідальність:** Моделі даних (опціонально)
```python
models/
└── __init__.py              # Моделі даних (TODO)
```

**Для майбутнього розвитку:**
- Dataclasses для даних
- Валідація даних
- Бізнес-логіка

## 🔄 Потік даних

### Приклад: Додавання доходу

```
1. Користувач натискає "➕ Записати новий дохід"
   │
   ▼
2. handlers/income.py: income_start()
   │ - Отримує типи доходів з locales
   │ - Створює клавіатуру з keyboards
   │ - Відправляє повідомлення користувачу
   ▼
3. Користувач обирає тип доходу
   │
   ▼
4. handlers/income.py: input_income_amount_standard()
   │ - Зберігає тип в temp_income_types
   │ - Запитує суму
   ▼
5. Користувач вводить суму
   │
   ▼
6. handlers/income.py: process_income_amount()
   │ - Валідує суму
   │ - Викликає database.add_income()
   ▼
7. database/income_repository.py: add_income()
   │ - Зберігає в БД
   │ - Повертає результат
   ▼
8. Користувач бачить підтвердження
```

## 🎯 Принципи дизайну

### 1. Separation of Concerns (Розділення відповідальності)
- Кожен модуль має свою чітку відповідальність
- Handlers - обробка повідомлень
- Database - робота з даними
- Keyboards - створення UI
- Locales - переклади

### 2. DRY (Don't Repeat Yourself)
- Спільний код винесено в утиліти
- Клавіатури централізовані
- Тексти в одному місці

### 3. Single Responsibility Principle
- Кожна функція робить одну річ
- Легко тестувати
- Легко підтримувати

### 4. Easy to Extend
- Додати нову мову - новий файл в locales/
- Додати новий handler - новий файл в handlers/
- Додати нову клавіатуру - нова функція в keyboards/

## 📈 Масштабування

### Додавання нової функції:

1. **Створити handler:**
   ```python
   # handlers/new_feature.py
   def register_handlers(bot):
       @bot.message_handler(...)
       def new_feature_handler(message):
           pass
   ```

2. **Зареєструвати в bot_instance.py:**
   ```python
   from handlers import new_feature
   new_feature.register_handlers(bot)
   ```

3. **Додати тексти в locales:**
   ```python
   # locales/uk.py
   'new_feature_text': 'Новий текст'
   ```

4. **Додати клавіатуру (якщо потрібно):**
   ```python
   # keyboards/main_keyboards.py
   def new_feature_keyboard():
       # ...
   ```

### Додавання нової мови:

1. **Створити файл:**
   ```python
   # locales/de.py
   TEXTS_DE = { ... }
   ```

2. **Зареєструвати в locale_manager.py:**
   ```python
   from .de import TEXTS_DE
   LANGUAGES = { 'uk': TEXTS_UK, 'en': TEXTS_EN, 'de': TEXTS_DE }
   ```

## 🔐 Безпека

- `.env` файл в `.gitignore`
- Токени не в коді
- SQL injection захист (prepared statements)
- Валідація користувацького вводу

## 📊 Майбутні покращення

1. **Логування:**
   - Додати модуль logging
   - Логувати всі операції

2. **Тести:**
   - Unit tests для handlers
   - Integration tests для БД

3. **Кешування:**
   - Redis для сесій
   - Кеш для часто використовуваних даних

4. **Аналітика:**
   - Графіки витрат/доходів
   - Прогнозування

5. **Нотифікації:**
   - Нагадування про бюджет
   - Щоденні/тижневі звіти
